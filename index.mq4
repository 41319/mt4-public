//+------------------------------------------------------------------+
//|                                                      HKIndex.mq4 |
//|                        Generated by MetaEditor                   |
//|                                              https://www.mql5.com |
//+------------------------------------------------------------------+
#property copyright "Your Name"
#property link      "https://www.yourwebsite.com"
#property version   "1.01"
#property strict

// Input parameters
input double LotSize = 0.01;
input int TakeProfitPoints = 50 * 100;
input int MaxOrders = 3;
input int MagicNumber = 12345;
input double PriceLevelAdjustment = 100;
input bool UsePercentage = false;

// Global variables
int ticket = -1;
double priceLevels[];
datetime lastCheckDate = 0;
double monthlyVolume = 0;
bool needUpdateLevels = false;

//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
{
   monthlyVolume = CalculateClosedVolumeThisMonth();
   UpdatePriceLevels();
   return(INIT_SUCCEEDED);
}

//+------------------------------------------------------------------+
//| Expert deinitialization function                                 |
//+------------------------------------------------------------------+
void OnDeinit(const int reason)
{
   Print("HKIndex EA deinitialized");
}

//+------------------------------------------------------------------+
//| Expert tick function                                             |
//+------------------------------------------------------------------+
void OnTick()
{
   bool isNewDay = TimeDay(TimeCurrent()) != TimeDay(lastCheckDate);
   
   if(isNewDay)
   {
      monthlyVolume = CalculateClosedVolumeThisMonth();
      Print("New day detected. Monthly volume so far: ", monthlyVolume);
      lastCheckDate = TimeCurrent();
   }
   
   if(needUpdateLevels || isNewDay)
   {
      UpdatePriceLevels();
      CloseAllPendingOrders();
      needUpdateLevels = false;
   }
   
   ManageOrders();
}

//+------------------------------------------------------------------+
//| Handle order close event                                         |
//+------------------------------------------------------------------+
void OnTrade()
{
   needUpdateLevels = true;
}

//+------------------------------------------------------------------+
//| Count existing orders with matching symbol and magic             |
//+------------------------------------------------------------------+
int CountOrders()
{
   int count = 0;
   for(int i = 0; i < OrdersTotal(); i++)
   {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
      {
         if(OrderSymbol() == Symbol() && OrderMagicNumber() == MagicNumber)
         {
            count++;
         }
      }
   }
   return count;
}

//+------------------------------------------------------------------+
//| Place a pending Buy Limit order                                  |
//+------------------------------------------------------------------+
void PlaceOrder(int index)
{
   double point = MarketInfo(Symbol(), MODE_POINT);
   int digits = (int)MarketInfo(Symbol(), MODE_DIGITS);
   double triggerPrice = priceLevels[index];
   double takeProfitPrice = NormalizeDouble(triggerPrice + TakeProfitPoints * point, digits);
   datetime expiryTime = TimeCurrent() + 86400; // 24 hours later

   // Safety check: triggerPrice must be below current Ask for BuyLimit
   if(triggerPrice >= MarketInfo(Symbol(), MODE_ASK))
   {
      Print("Trigger price is too high for BuyLimit. Skipping. Trigger: ", triggerPrice, " >= Ask: ", MarketInfo(Symbol(), MODE_ASK));
      return;
   }

   Print(Symbol(), " | Attempting BUYLIMIT | Price: ", triggerPrice, ", TP: ", takeProfitPrice);
   ticket = OrderSend(Symbol(), OP_BUYLIMIT, LotSize, triggerPrice, 3, 0, takeProfitPrice, "HKIndex EA", MagicNumber, expiryTime, clrGreen);

   if(ticket < 0)
   {
      int errorCode = GetLastError();
      Print("OrderSend failed with error #", errorCode);
   }
   else
   {
      Print("Order placed. Ticket #", ticket, " @ ", triggerPrice, ", TP @ ", takeProfitPrice);
   }
}

//+------------------------------------------------------------------+
//| Manage all orders - create new ones if needed                    |
//+------------------------------------------------------------------+
void ManageOrders()
{
   int count = CountOrders();
   
   for(int i = 0; i < MaxOrders; i++)
   {
      bool orderExists = false;
      for(int j = 0; j < OrdersTotal(); j++)
      {
         if(OrderSelect(j, SELECT_BY_POS, MODE_TRADES))
         {
            if(OrderSymbol() == Symbol() && OrderMagicNumber() == MagicNumber &&
               MathAbs(OrderOpenPrice() - priceLevels[i]) < MarketInfo(Symbol(), MODE_POINT))
            {
               orderExists = true;
               break;
            }
         }
      }

      if(!orderExists && count < MaxOrders)
      {
         PlaceOrder(i);
         count++;
      }
   }
}

//+------------------------------------------------------------------+
//| Update price levels based on current market price                |
//+------------------------------------------------------------------+
void UpdatePriceLevels()
{
   double currentPrice = MarketInfo(Symbol(), MODE_BID); // Using BID price for calculations
   ArrayResize(priceLevels, MaxOrders);
   
   for(int i = 0; i < MaxOrders; i++)
   {
      if(UsePercentage)
      {
         priceLevels[i] = currentPrice * (1 - (PriceLevelAdjustment / 100.0 * (i + 1)));
      }
      else
      {
         priceLevels[i] = NormalizeDouble(currentPrice - (PriceLevelAdjustment * (i + 1) * MarketInfo(Symbol(), MODE_POINT)), (int)MarketInfo(Symbol(), MODE_DIGITS));
      }
      Print("Price Level ", i+1, ": ", priceLevels[i]);
   }
}

//+------------------------------------------------------------------+
//| Close all pending orders                                         |
//+------------------------------------------------------------------+
void CloseAllPendingOrders()
{
   for(int i = OrdersTotal()-1; i >= 0; i--)
   {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
      {
         if(OrderSymbol() == Symbol() && OrderMagicNumber() == MagicNumber && OrderType() == OP_BUYLIMIT)
         {
            bool result = OrderDelete(OrderTicket());
            if(result)
            {
               Print("Pending order deleted. Ticket #", OrderTicket());
            }
            else
            {
               Print("Failed to delete order. Ticket #", OrderTicket(), " Error: ", GetLastError());
            }
         }
      }
   }
}

//+------------------------------------------------------------------+
//| Function to calculate closed order volume for the current month  |
//+------------------------------------------------------------------+
double CalculateClosedVolumeThisMonth()
{
    double totalVolume = 0.0;
    datetime currentTime = TimeCurrent();
    int currentMonth = TimeMonth(currentTime);
    int currentYear = TimeYear(currentTime);
    
    // Calculate the start of the month
    datetime monthStart = StrToTime(StringFormat("%d.%02d.01 00:00", currentYear, currentMonth));
    
    // Loop through closed orders in history
    for(int i = OrdersHistoryTotal()-1; i >= 0; i--)
    {
        if(OrderSelect(i, SELECT_BY_POS, MODE_HISTORY))
        {
            // Check if order was closed this month and has our magic number
            if(OrderCloseTime() >= monthStart && OrderCloseTime() <= currentTime && OrderMagicNumber() == MagicNumber)
            {
                totalVolume += OrderLots();
            }
        }
    }
    return totalVolume;
}